# pico-earthquake-mon

Raspberry Pi Pico W„Çí‰Ωø„Å£„Å¶„ÄåÂú∞ÈúáÊÉÖÂ†±„Çí„É™„Ç¢„É´„Çø„Ç§„É†„Äç„ÅßË°®Á§∫„Åô„Çã„Ç§„É≥„Éï„Ç©„É°„Éº„Ç∑„Éß„É≥„É¢„Éã„Çø„Åß„Åô„ÄÇ

Âú∞ÈúáÊÉÖÂ†±„ÅØ„ÄåP2PÂú∞ÈúáÊÉÖÂ†±„Äç„ÅåÊèê‰æõ„Åó„Å¶„ÅÑ„ÇãWebSocket„ÅßÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

[P2PÂú∞ÈúáÊÉÖÂ†± - Wikipedia](https://ja.wikipedia.org/wiki/P2P%E5%9C%B0%E9%9C%87%E6%83%85%E5%A0%B1)

Âú∞ÈúáÊÉÖÂ†±„ÅØ„ÄÅÈúáÊ∫êÂú∞„ÉªÂú∞Èúá„ÅÆÊ∑±„Åï„ÉªÁô∫ÁîüÊó•ÊôÇ„ÉªÈúáÂ∫¶„ÉªË¶èÊ®°„ÅÆ5„Å§„ÅåOLEDÔºà128√ó32Ôºâ„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ

Êè∫„Çå„ÇíÂèñÂæó„Åó„ÅüÈÉΩÈÅìÂ∫úÁúå„ÅØÂü∫Êùø‰∏ä„ÅÆÂêÑLED„Å´ÂØæÂøú„Åó„Å¶„Åä„Çä„ÄÅÊè∫„Çå„ÅüÈÉΩÈÅìÂ∫úÁúå„Å´ÂØæÂøú„Åó„ÅüLED„ÅåÁÇπÁÅØ„Åó„Åæ„Åô„ÄÇ

„É™„ÉÅ„Ç¶„É†„Ç§„Ç™„É≥ÈõªÊ±†Ôºà18650Ôºâ„Çí‰Ωø„ÅÜ„ÅÆ„Åß„ÄÅ„Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥„Åß‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ

----

## ÈñãÁô∫Áí∞Â¢É

„ÉªMicroPython(v1.22.2)

„ÉªThonny(v4.0.2)

----

## Âãï‰Ωú„ÅÆÊßòÂ≠ê

![Âãï‰Ωú](img/example.gif)

ÂÆüÈöõ„ÅÆÂãï‰Ωú„ÅÆÊßòÂ≠ê„Åß„Åô„ÄÇ

Âèó‰ø°„Åô„ÇãÂú∞ÈúáÊÉÖÂ†±„Å´„Å§„ÅÑ„Å¶„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†„ÅÆ„ÇÇ„ÅÆ„Åß„ÅØ„Å™„Åè„ÉÄ„Éü„ÉºÁî®„Å´Ë°®Á§∫„Åó„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„Åß„Åô„ÄÇ

ÂúüÂè∞„ÅØ3D„Éó„É™„É≥„ÇøÔºàÂÖâÈÄ†ÂΩ¢Ôºâ„Åß‰ΩúË£Ω„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

STL„Éï„Ç°„Ç§„É´„ÅØ[case.stl](hogehoge)„Å´„ÅÇ„Çä„Åæ„Åô„ÄÇ

----

## ÈÉ®ÂìÅ„É™„Çπ„Éà

|ÈÉ®ÂìÅÂêç|ÂÄãÊï∞|Ë≥ºÂÖ•ÂÖà„É™„É≥„ÇØ|Ê≥®ÊÑè|
|:--|:--|:--|:--|
|„É°„Ç§„É≥Âü∫Êùø|1||BOOTH„Å´Âá∫ÂìÅ‰∫àÂÆöÔºü|
|Raspberry Pi Pico W|1|https://akizukidenshi.com/catalog/g/g117947/||
|„Çø„ÇØ„Éà„Çπ„Ç§„ÉÉ„ÉÅ|1|https://akizukidenshi.com/catalog/g/g103646/|Pi Pico„É™„Çª„ÉÉ„ÉàÁî®„ÄÇËâ≤„ÅØ„Å™„Çì„Åß„ÇÇ„Çà„ÅÑ|
|TP4056 „É™„ÉÅ„Ç¶„É†ÈõªÊ±†ÂÖÖÈõª„É¢„Ç∏„É•„Éº„É´|1|https://amzn.asia/d/iQMhM1q|AmazonÁ≠â„Å´Âá∫Âõû„Å£„Å¶„ÅÑ„ÇãÊ±éÁî®ÂÖÖÈõª„É¢„Ç∏„É•„Éº„É´|
|XH„Ç≥„Éç„ÇØ„Çø „É°„Çπ|2|https://akizukidenshi.com/catalog/g/g112247/||
|XH„Ç≥„Éç„ÇØ„Çø „Ç™„Çπ|1-2|https://akizukidenshi.com/catalog/g/g112255/||
|XH„Ç≥„Éç„ÇØ„Çø „Ç≥„É≥„Çø„ÇØ„Éà|2|https://akizukidenshi.com/catalog/g/g112264/||
|„É™„ÉÅ„Ç¶„É†ÈõªÊ±†Ôºà18650Ôºâ|1|„É™„É≥„ÇØÁúÅÁï•|Áîü„Çª„É´„Åß„ÇÇÂèØ|
|„É™„ÉÅ„Ç¶„É†ÈõªÊ±†Ôºà18650ÔºâÈõªÊ±†„Éú„ÉÉ„ÇØ„Çπ|1|https://akizukidenshi.com/catalog/g/g108407/||
|ÈõªÁ∑ö|ÈÅ©ÂÆú|https://akizukidenshi.com/catalog/g/g110672/||
|„Ç∑„Éß„ÉÉ„Éà„Ç≠„Éº„Éê„É™„Ç¢„ÉÄ„Ç§„Ç™„Éº„ÉâSB240LES|1|https://akizukidenshi.com/catalog/g/g107787/||
|„Ç≥„É≥„Éá„É≥„Çµ 0.15uF 50V|6|https://akizukidenshi.com/catalog/g/g108145/|„Éê„Ç§„Éë„Çπ„Ç≥„É≥„Éá„É≥„Çµ„ÄÇ„Çø„É≥„Çø„É´„Ç≥„É≥„Éá„É≥„Çµ„ÅåÂ•Ω„Åæ„Åó„ÅÑ|
|TC74HC595AF|6|https://akizukidenshi.com/catalog/g/g110077/|8bit„Ç∑„Éï„Éà„É¨„Ç∏„Çπ„Çø|
|Á∑ëËâ≤„ÉÅ„ÉÉ„ÉóLED 1608|49|https://akizukidenshi.com/catalog/g/g111878/||
|„ÉÅ„ÉÉ„ÉóÊäµÊäó 1/10W 3kŒ©|49|https://akizukidenshi.com/catalog/g/g106302/|Áú©„Åó„ÅÑ„Åü„ÇÅ6kŒ©Á®ãÂ∫¶„ÅåÊúõ„Åæ„Åó„ÅÑ|
|Á¥∞„Éî„É≥„Éò„ÉÉ„ÉÄ|20*2 4 6|https://akizukidenshi.com/catalog/g/g104398/|Pi PicoÂõ∫ÂÆöÁî®„Å®OLEDÂõ∫ÂÆöÁî®„Å®TP4056„É¢„Ç∏„É•„Éº„É´Âõ∫ÂÆöÁî®|
|M3√ó35„Éú„É´„Éà|2|„É™„É≥„ÇØÁúÅÁï•|Âü∫ÊùøÁ´ã„Å¶Áî®„ÄÇÈï∑„Åï„ÅØ35mm„Åß„Å™„Åè„Å¶„ÇÇ„Çà„ÅÑ|
|M3„Éä„ÉÉ„Éà|2|„É™„É≥„ÇØÁúÅÁï•|Âü∫ÊùøÁ´ã„Å¶Áî®|
|„ÅØ„Çì„Å†|ÈÅ©ÂÆú|„É™„É≥„ÇØÁúÅÁï•|„ÅØ„Çì„Å†Áî®|

----

## „Éñ„É≠„ÉÉ„ÇØÂõ≥

![„Éñ„É≠„ÉÉ„ÇØÂõ≥](img/block.png)

‚òÖRaspberry Pi Pico W„ÇíP2PÂú∞ÈúáÊÉÖÂ†±„Å®WebSocket„Çí‰Ωø„ÅÑÈÄö‰ø°„Åó„Åæ„Åô„ÄÇ

‚òÖWebSocket„Å´Connect„Åó„ÄÅÂú∞ÈúáÊÉÖÂ†±„ÅÆÂèó‰ø°„ÇíÂæÖÊ©ü„Åó„Åæ„Åô„ÄÇ

‚òÖÂèó‰ø°„Åó„ÅüÊÉÖÂ†±„Çí„Éë„Éº„Çπ„Åó„ÄÅOLED„Å´Âú∞ÈúáÊÉÖÂ†±„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ

‚òÖÂèó‰ø°„Åó„ÅüÊÉÖÂ†±„Çí„Éë„Éº„Çπ„Åó„ÄÅÊè∫„Çå„ÅüÈÉΩÈÅìÂ∫úÁúå„ÇíÂèñÂæó„Åó„ÄÅÂü∫Êùø‰∏ä„ÅßÂØæÂøú„Åô„ÇãLED„ÇíÁÇπÁÅØ„Åï„Åõ„Åæ„Åô„ÄÇ

‚òÖ47ÈÉΩÈÅìÂ∫úÁúå„Å™„ÅÆ„Åß„ÄÅLED„ÅØ47ÂÄã„ÅÇ„Çä„Åæ„Åô„ÄÇLED„ÅÆÂà∂Âæ°„ÅØ„Ç∑„Éï„Éà„É¨„Ç∏„Çπ„ÇøÔºà74HC595Ôºâ„ÇíÁî®„ÅÑ„Åæ„Åô„ÄÇ

‚òÖ‰∏äË®ò47ÂÄã„Å´Âä†„Åà„Å¶„ÄÅÁ∑äÊÄ•Âú∞ÈúáÈÄüÂ†±„ÇíÁ§∫„ÅôLED„Å®Ê©üÂô®„ÅÆÊé•Á∂öÁä∂Ê≥Å„ÇíÁ§∫„ÅôLED„ÅÆ2ÂÄã„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

‚òÖ„Çπ„Çø„É≥„Éâ„Ç¢„É≠„É≥„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„ÄÅTP4056„É¢„Ç∏„É•„Éº„É´„Çí‰ªã„Åó„Å¶Raspberry Pi Pico W„ÅÆVsys„Éî„É≥„Å∏ÈõªÊ∫ê„Çí‰æõÁµ¶„Åó„Åæ„Åô„ÄÇ

----

## ÂõûË∑ØÂõ≥

![ÂõûË∑ØÂõ≥](img/schematic.png)

‚òÖ„Ç∑„Éï„Éà„É¨„Ç∏„Çπ„Çø„ÅØ„Ç´„Çπ„Ç±„Éº„ÉâÊé•Á∂ö„Åï„Åõ„Å¶„ÅÑ„Åæ„Åô„ÄÇ

‚òÖRaspberry Pi Pico W„ÅÆVsys„Å´ÈõªÊ∫ê‰æõÁµ¶„ÅóÂãï‰Ωú„Åï„Åõ„ÇãÂ†¥Âêà„ÄÅ„Ç∑„Éß„ÉÉ„Éà„Ç≠„Éº„Éê„É™„Ç¢„ÉÄ„Ç§„Ç™„Éº„Éâ„ÅåÂøÖÈ†à„Åß„Åô„ÄÇ

‚òÖ„Ç∑„Éß„ÉÉ„Éà„Ç≠„Éº„Éê„É™„Ç¢„ÉÄ„Ç§„Ç™„Éº„Éâ„ÅØ‰∏ÄËà¨ÁöÑ„Å™„ÉÄ„Ç§„Ç™„Éº„ÉâÁâπÊÄß„Å´Âä†„Åà„ÄÅÈ†ÜÊñπÂêëÈõªÂúßÔºàVfÔºâ„Åå‰Ωé„ÅÑÁÇπ„ÅåÁâπÂæ¥„Åß„Åô„ÄÇ

----

## „Ç¨„Éº„Éê„Éº„Éá„Éº„ÇøÔºàÂü∫ÊùøÁô∫Ê≥®„ÅÆ„Åü„ÇÅ„ÅÆ„Éá„Éº„ÇøÔºâ

„Ç¨„Éº„Éê„Éº„Éá„Éº„Çø„ÅØ[„Åì„Åì](https://github.com/underMHz/pico-earthquake-mon/blob/main/gerber_pico-earthquake-mon.zip)„Åã„ÇâDL„Åß„Åç„Åæ„Åô„ÄÇ

[JLCPCB](https://jlcpcb.com/)„Åß„ÅÆÁô∫Ê≥®„ÇíÊÉ≥ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

![Âü∫Êùø](img/gerber.png)

----

## Êé•Á∂ö

|PicoW|OLED|74HC595|TP4056 Module|Other|
|:--|:--|:--|:--|:--|
|`VSYS`||`VCC`|`OUT+`||
|`3V3`|`VCC`|`SRCLR`|||
|`GND`|`GND`|`GND` `OE`|`OUT-`||
|`RUN`||||`GND`|
|`GPIO16`||`SER`|||
|`GPIO17`||`RCLK`|||
|`GPIO18`||`SRCLK`|||
|`GPIO20`|`SDA`||||
|`GPIO21`|`SCL`||||
||||`B+`|`Li-Battery+`|
||||`B-`|`Li-Battery-`|
||||`Vin`|`USB+`|
||||`GND`|`USB-`|

„ÉªGPIO10„Å´Á∑äÊÄ•Âú∞ÈúáÈÄüÂ†±Ë°®Á§∫Áî®„ÅÆLED„ÇíÊé•Á∂ö

„ÉªGPIO11„Å´StatusË°®Á§∫Áî®„ÅÆLED„ÇíÊé•Á∂ö

----

## „Éï„Ç°„Ç§„É´ÊßãÊàê

- Thonny„Åã„ÇâPython Package Index(PyPI)„Åã„Çâ„Ç§„É≥„Çπ„Éà„Éº„É´„Åô„Çã„É©„Ç§„Éñ„É©„É™

`ssd1306`

- Â§ñÈÉ®„Åã„ÇâËøΩÂä†„Åô„Çã„É©„Ç§„Éñ„É©„É™

`uwebsocketsclient`
https://github.com/underMHz/uwebsockets-client/blob/main/uwebsocketsclient.py

`P2PÂú∞ÈúáÊÉÖÂ†±Ôºàhttps://www.p2pquake.net/Ôºâ„ÅÆË®ºÊòéÊõ∏(www.p2pquake.net.crt)`
ÂèñÂæóÊñπÊ≥ï„ÅØ„Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÊàêÂõ≥„ÅÆ‰∏ã„Å´Ë®òËºâ„ÄÇ

- ‰ΩøÁî®„Åô„Çã„Éï„Ç©„É≥„Éà

`misakifont`ÔºàÁæéÂí≤„Éï„Ç©„É≥„ÉàÔºâ
https://github.com/Tamakichi/pico_MicroPython_misakifont/tree/main/misakifont

‚ùìÁæéÂí≤„Éï„Ç©„É≥„Éà„Å´„Å§„ÅÑ„Å¶
https://littlelimit.net/misaki.htm

```
Raspberry Pi Pico/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ ssd1306.py
‚îÇ   ‚îú‚îÄ‚îÄ uwebsocketsclient.py
‚îÇ   ‚îî‚îÄ‚îÄ www.p2pquake.net.crt
‚îú‚îÄ‚îÄ misakifont/
‚îÇ   ‚îú‚îÄ‚îÄ misakifont.py
‚îÇ   ‚îú‚îÄ‚îÄ misakifontdata.py
‚îÇ   ‚îú‚îÄ‚îÄ tma_jp_utl.py
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ all_led_test.py
‚îî‚îÄ‚îÄ main.py
```

- Ë®ºÊòéÊõ∏(www.p2pquake.net.crt)„ÅÆÂèñÂæóÊñπÊ≥ï

ÔºàÂ∑•‰∫ã‰∏≠üî®Ôºâ

----

## „Ç≥„Éº„Éâ„Å´„Å§„ÅÑ„Å¶

MicroPython„ÅßÈñãÁô∫„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ

„Ç≥„Éº„Éâ„ÅØ[„Åì„Åì](hogehoge)„Åã„ÇâDL„Åß„Åç„Åæ„Åô„ÄÇ

main.py„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„ÄÇ

```Python
from machine import Pin, I2C
import ssd1306
import framebuf
import time
import sys

import network
import ntptime

from uwebsocketsclient import connect
import ujson as json

from misakifont import MisakiFont

# sandbox (Virtual environment)
#uri = 'wss://api-realtime-sandbox.p2pquake.net:443/v2/ws'

# Production environment
uri = 'wss://api.p2pquake.net:443/v2/ws'

'''
PIN & WiFi Setting
'''
ssid = '***YOUR SSID (2.4GHz)***'
password = '***YOUR PASSWORD***'

alert_led = Pin(10, Pin.OUT)
status_led = Pin(11, Pin.OUT)

# I2C setting (SDA->20, SCL->21)
i2c = I2C(0, sda=Pin(20), scl=Pin(21) )
# Display setting
oled = ssd1306.SSD1306_I2C(128, 32, i2c)

# GP16 -> 14(74HC595)
# GP17 -> 12(74HC595)
# GP18 -> 11(74HC595)
ser_pin = 16
latch_pin = 17
clk_pin = 18

ser = Pin(ser_pin, Pin.OUT)
latch = Pin(latch_pin, Pin.OUT)
clock = Pin(clk_pin, Pin.OUT)

'''
Function to display the point at which the earthquake occurred
'''
fcolor = 1
mf = MisakiFont()

def show_text(text, x, y, fsize, xmax):
    x_origin = x
    for c in text:
        fd = mf.font(ord(c))
        show_bitmap(oled, fd, x, y, fcolor, fsize)
        x += 8 * fsize
        if x >= xmax:
            x = x_origin
            y += 8 * fsize
    oled.show()

def show_bitmap(oled, fd, x, y, color, size):
    for row in range(0, 7):
        for col in range(0, 7):
            if (0x80 >> col) & fd[row]:
                oled.fill_rect(int(x + col * size), int(y + row * size), size, size, color)

'''
functions
'''
def zfill(s, width):
    if len(s) < width:
        return ('0' * (width - len(s))) + s
    else:
        return s
    
def setRegister(ser, clock, val):
    for i in range(0, 8):
        # CLOCK : LOW -> HIGH
        clock.off()
        # Input data in order from the least significant bit
        ser.value(val & (0x01 << i))
        clock.on()
        
def scale_to_value(scale):
    scale_dict = {
        "-1": "?",
        "10": "1",
        "20": "2",
        "30": "3",
        "40": "4",
        "50": "5Âº±",
        "55": "5Âº∑",
        "60": "6Âº±",
        "65": "6Âº∑",
        "70": "7"
    }
    return scale_dict.get(str(scale), "?")

def seismic_intensity(max_scale_value):
    if len(max_scale_value) >= 2:
        max_scale_scale = max_scale_value[1:]
        max_scale_value = max_scale_value[:1]
        show_text(max_scale_scale, 120, 8, 1, 128)
    show_text(max_scale_value, 104, 0, 2, 128)

def seismic_magnitude(magnitude):
    magnitude = str(magnitude)
    show_text('M', 104, 16, 1, 128)
    show_text(magnitude, 104, 24, 1, 128)

def happen_date(date):
    show_text(date, 4, 16, 1, 96)

def happen_time(time):
    show_text(time, 4, 24, 1, 96)

def happen_depth(depth):
    show_text(depth, 0, 8, 1, 96)

def happen_location(location):
    show_text(location, 4, 0, 1, 96)
    
def make_frame():
    oled.fill_rect(0, 0, 2, 8, 1)
    oled.fill_rect(0, 16, 2, 16, 1)
    oled.fill_rect(100, 0, 2, 31, 1)

'''
Prefectures List
'''
def pref_to_led(pref):
    sr1 = {
        "ÂåóÊµ∑ÈÅì": 0b10000000,
        "ÈùíÊ£ÆÁúå": 0b01000000,
        "Â≤©ÊâãÁúå": 0b00100000,
        "ÂÆÆÂüéÁúå": 0b00010000,
        "ÁßãÁî∞Áúå": 0b00001000,
        "Â±±ÂΩ¢Áúå": 0b00000100,
        "Á¶èÂ≥∂Áúå": 0b00000010,
        "Ëå®ÂüéÁúå": 0b00000001,
        "ÈùíÊ£Æ": 0b01000000,
        "Â≤©Êâã": 0b00100000,
        "ÂÆÆÂüé": 0b00010000,
        "ÁßãÁî∞": 0b00001000,
        "Â±±ÂΩ¢": 0b00000100,
        "Á¶èÂ≥∂": 0b00000010,
        "Ëå®Âüé": 0b00000001
    }

    sr2 = {
        "Ê†ÉÊú®Áúå": 0b10000000,
        "Áæ§È¶¨Áúå": 0b01000000,
        "ÂüºÁéâÁúå": 0b00100000,
        "ÂçÉËëâÁúå": 0b00010000,
        "Êù±‰∫¨ÈÉΩ": 0b00001000,
        "Á•ûÂ•àÂ∑ùÁúå": 0b00000100,
        "Êñ∞ÊΩüÁúå": 0b00000010,
        "ÂØåÂ±±Áúå": 0b00000001,
        "Ê†ÉÊú®": 0b10000000,
        "Áæ§È¶¨": 0b01000000,
        "ÂüºÁéâ": 0b00100000,
        "ÂçÉËëâ": 0b00010000,
        "Êù±‰∫¨": 0b00001000,
        "Á•ûÂ•àÂ∑ù": 0b00000100,
        "Êñ∞ÊΩü": 0b00000010,
        "ÂØåÂ±±": 0b00000001
    }

    sr3 = {
        "Áü≥Â∑ùÁúå": 0b10000000,
        "Á¶è‰∫ïÁúå": 0b01000000,
        "Â±±Ê¢®Áúå": 0b00100000,
        "Èï∑ÈáéÁúå": 0b00010000,
        "Â≤êÈòúÁúå": 0b00001000,
        "ÈùôÂ≤°Áúå": 0b00000100,
        "ÊÑõÁü•Áúå": 0b00000010,
        "‰∏âÈáçÁúå": 0b00000001,
        "Áü≥Â∑ù": 0b10000000,
        "Á¶è‰∫ï": 0b01000000,
        "Â±±Ê¢®": 0b00100000,
        "Èï∑Èáé": 0b00010000,
        "Â≤êÈòú": 0b00001000,
        "ÈùôÂ≤°": 0b00000100,
        "ÊÑõÁü•": 0b00000010,
        "‰∏âÈáç": 0b00000001
    }

    sr4 = {
        "ÊªãË≥ÄÁúå": 0b10000000,
        "‰∫¨ÈÉΩÂ∫ú": 0b01000000,
        "Â§ßÈò™Â∫ú": 0b00100000,
        "ÂÖµÂ∫´Áúå": 0b00010000,
        "Â•àËâØÁúå": 0b00001000,
        "ÂíåÊ≠åÂ±±Áúå": 0b00000100,
        "È≥•ÂèñÁúå": 0b00000010,
        "Â≥∂Ê†πÁúå": 0b00000001,
        "ÊªãË≥Ä": 0b10000000,
        "‰∫¨ÈÉΩ": 0b01000000,
        "Â§ßÈò™": 0b00100000,
        "ÂÖµÂ∫´": 0b00010000,
        "Â•àËâØ": 0b00001000,
        "ÂíåÊ≠åÂ±±": 0b00000100,
        "È≥•Âèñ": 0b00000010,
        "Â≥∂Ê†π": 0b00000001
    }

    sr5 = {
        "Â≤°Â±±Áúå": 0b10000000,
        "Â∫ÉÂ≥∂Áúå": 0b01000000,
        "Â±±Âè£Áúå": 0b00100000,
        "Âæ≥Â≥∂Áúå": 0b00010000,
        "È¶ôÂ∑ùÁúå": 0b00001000,
        "ÊÑõÂ™õÁúå": 0b00000100,
        "È´òÁü•Áúå": 0b00000010,
        "Á¶èÂ≤°Áúå": 0b00000001,
        "Â≤°Â±±": 0b10000000,
        "Â∫ÉÂ≥∂": 0b01000000,
        "Â±±Âè£": 0b00100000,
        "Âæ≥Â≥∂": 0b00010000,
        "È¶ôÂ∑ù": 0b00001000,
        "ÊÑõÂ™õ": 0b00000100,
        "È´òÁü•": 0b00000010,
        "Á¶èÂ≤°": 0b00000001
    }

    sr6 = {
        "‰ΩêË≥ÄÁúå": 0b10000000,
        "Èï∑Â¥éÁúå": 0b01000000,
        "ÁÜäÊú¨Áúå": 0b00100000,
        "Â§ßÂàÜÁúå": 0b00010000,
        "ÂÆÆÂ¥éÁúå": 0b00001000,
        "ÈπøÂÖêÂ≥∂Áúå": 0b00000100,
        "Ê≤ñÁ∏ÑÁúå": 0b00000010,
        "‰ΩêË≥Ä": 0b10000000,
        "Èï∑Â¥é": 0b01000000,
        "ÁÜäÊú¨": 0b00100000,
        "Â§ßÂàÜ": 0b00010000,
        "ÂÆÆÂ¥é": 0b00001000,
        "ÈπøÂÖêÂ≥∂": 0b00000100,
        "Ê≤ñÁ∏Ñ": 0b00000010
    }
    
    # Make list named srs
    srs = [sr1, sr2, sr3, sr4, sr5, sr6]
    
    # Initial
    initial_binary = 0
    sr1_send = sr2_send = sr3_send = sr4_send = sr5_send = sr6_send = initial_binary

    for idx, sr in enumerate(srs, start=1):
        for prefecture in pref:
            if prefecture in sr:
                bit_value = sr[prefecture]

                if idx == 1:
                    sr1_send = sr1_send + bit_value
                elif idx == 2:
                    sr2_send = sr2_send + bit_value
                elif idx == 3:
                    sr3_send = sr3_send + bit_value
                elif idx == 4:
                    sr4_send = sr4_send + bit_value
                elif idx == 5:
                    sr5_send = sr5_send + bit_value
                elif idx == 6:
                    sr6_send = sr6_send + bit_value

    # LATCH : LOW -> HIGH
    latch.off()
    setRegister(ser, clock, sr6_send)
    setRegister(ser, clock, sr5_send)
    setRegister(ser, clock, sr4_send)
    setRegister(ser, clock, sr3_send)
    setRegister(ser, clock, sr2_send)
    setRegister(ser, clock, sr1_send)
    latch.on()

'''
RESET LED
'''
status_led.off()
alert_led.off()

initial_binary = 0
sr1_send = sr2_send = sr3_send = sr4_send = sr5_send = sr6_send = initial_binary

latch.off()
setRegister(ser, clock, sr6_send)
setRegister(ser, clock, sr5_send)
setRegister(ser, clock, sr4_send)
setRegister(ser, clock, sr3_send)
setRegister(ser, clock, sr2_send)
setRegister(ser, clock, sr1_send)
latch.on()

'''
Display at startup
'''
# Display MicroPython logo
oled.fill_rect(0, 0, 32, 32, 1)
oled.fill_rect(2, 2, 28, 28, 0)
oled.vline(9, 8, 22, 1)
oled.vline(16, 2, 22, 1)
oled.vline(23, 8, 22, 1)
oled.fill_rect(26, 24, 2, 4, 1)
# Display text
oled.text('Run by', 40, 7, 1)
oled.text('MicroPython', 40, 17, 1)
# Show
oled.show()
time.sleep(1.5)

# Hiding the text
oled.fill_rect(32, 0, 128, 32, 0)
oled.show()

'''
Setup to connect to WiFi
'''
wlan = network.WLAN(network.STA_IF)
wlan.active(True)
wlan.connect(ssid, password)

# Loop until connection is established
max_wait = 0
while max_wait <= 20:
    # Hiding the text
    oled.fill_rect(32, 0, 128, 32, 0)
    oled.show()
    if wlan.status() < 0 or wlan.status() >= 3:
        break
    # Display text
    oled.text('Connection', 40, 7, 1)
    oled.text(f'trial:{max_wait}/20', 40, 17, 1)
    oled.show()
    max_wait += 1
    time.sleep(1)
    
wlan_status = wlan.status()
print('Status code:' +str(wlan_status))

# Handle connection error
# Error meanings
# 0  Link Down
# 1  Link Join
# 2  Link NoIp
# 3  Link Up
# -1 Link Fail
# -2 Link NoNet
# -3 Link BadAuth

status = wlan.ifconfig()
#print('ip = ' + status[0])

if wlan_status == 3:
    # Display text
    oled.text('WiFi is', 40, 7, 1)
    oled.text('connected!!', 40, 17, 1)
    # Show
    oled.show()
    time.sleep(1.5)
    # Clear display
    oled.fill(0)
    oled.show()
else:
    # Display text
    oled.text('WiFi is NOT', 40, 7, 1)
    oled.text('connected!!', 40, 17, 1)
    # Show
    oled.show()
    status_led.on()
    sys.exit()

'''
Obtain the time from an NTP server 
(since the time information must be added to the certificate or it will be rejected)
'''
ntptime.settime()

'''
Raspberry Pi Logo
'''
# Raspberry Pi logo as 32x32 bytearray
buffer = bytearray(b"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00|?\x00\x01\x86@\x80\x01\x01\x80\x80\x01\x11\x88\x80\x01\x05\xa0\x80\x00\x83\xc1\x00\x00C\xe3\x00\x00~\xfc\x00\x00L'\x00\x00\x9c\x11\x00\x00\xbf\xfd\x00\x00\xe1\x87\x00\x01\xc1\x83\x80\x02A\x82@\x02A\x82@\x02\xc1\xc2@\x02\xf6>\xc0\x01\xfc=\x80\x01\x18\x18\x80\x01\x88\x10\x80\x00\x8c!\x00\x00\x87\xf1\x00\x00\x7f\xf6\x00\x008\x1c\x00\x00\x0c \x00\x00\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00")
fb = framebuf.FrameBuffer(buffer, 32, 32, framebuf.MONO_HLSB)
oled.blit(fb, 49, 0)
oled.show()

'''
functions for getting earthquake information using Websocket
'''
websocket = connect(uri)
 
try:
    while True:
        data = websocket.recv()
        data = json.loads(data)
        
        code = data['code']
            
        # code:556 -> Earthquake Early Warning Alert
        if code == 556:
            # ON alertLED
            alert_led.on()                
            time = data['earthquake']['arrivalTime']
            # No data -> max_scale = data['earthquake']['maxScale']
            max_scale = '!'
            magnitude = data['earthquake']['hypocenter']['magnitude']
            depth = data['earthquake']['hypocenter']['depth']
            location = data['earthquake']['hypocenter']['name']
            
            pref = list(set(point['pref'] for point in data['areas']))
            
            if magnitude == -1:
                magnitude = '?'
                
            if location == '':
                location = 'Ë®àÊ∏¨‰∏≠'

            if depth == -1:
                depth = '?'

            depth = f'ÔºàÊ∑±„ÅïÔºö{depth}„éûÔºâ'
            
            date = time.split()[0]
            time = time.split()[1]
            
            oled.fill(0)
            oled.show()
            
            # Display earthquake information
            seismic_intensity(max_scale_value)
            seismic_magnitude(magnitude)
            happen_depth(depth)
            happen_location(location)
            happen_date(date)
            happen_time(time)
            make_frame()
            oled.show()
            
            # Show the prefecture with LED
            pref_to_led(pref)
            
        # code:551 -> Earthquake Information
        elif code == 551:
            # Reset alertLED
            alert_led.off() 
            time = data['earthquake']['time']
            max_scale = data['earthquake']['maxScale']
            magnitude = data['earthquake']['hypocenter']['magnitude']
            depth = data['earthquake']['hypocenter']['depth']
            location = data['earthquake']['hypocenter']['name']
            
            pref = list(set(point['pref'] for point in data['points']))
            
            # Converts maximum seismic intensity ID to a numerical value
            max_scale_value = scale_to_value(max_scale)

            if magnitude == -1:
                magnitude = '?'
                
            if location == '':
                location = 'Ë®àÊ∏¨‰∏≠'

            if depth == -1:
                depth = '?'

            depth = f'ÔºàÊ∑±„ÅïÔºö{depth}„éûÔºâ'
            
            date = time.split()[0]
            time = time.split()[1]
            
            oled.fill(0)
            oled.show()
            
            # Display earthquake information
            seismic_intensity(max_scale_value)
            seismic_magnitude(magnitude)
            happen_depth(depth)
            happen_location(location)
            happen_date(date)
            happen_time(time)
            make_frame()
            oled.show()
            
            # Show the prefecture with LED
            pref_to_led(pref)

        else:
            # Blink
            status_led.on()
            time.sleep(0.5)
            status_led.off()
            time.sleep(0.5)
            status_led.on()
            time.sleep(0.5)
            status_led.off()
            time.sleep(0.5)
            
except Exception as e:
    status_led.on()
    oled.fill(0)
    oled.show()
    show_text(f'Error:{e}', 0, 0, 1, 128)

finally:
    # Close WebSocket
    websocket.close()
```

----
